<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MerchantHaus — Dashboard (Improved)</title>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Major+Mono+Display&display=swap" rel="stylesheet">
  <!-- Styles: dark theme similar to new portal -->
  <style>
    :root {
      --brand-red: #ef3c5b;
      --brand-green: #6dffca;
      --ink: #f5f5f5;
      --muted: #b3b3b3;
      --bg-surface: rgba(255, 255, 255, .06);
      --border-color: rgba(255, 255, 255, .12);
      --main-bg: #020617;
      --header-bg: rgba(0,0,0,.35);
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: var(--ink);
      background-color: var(--main-bg);
      overflow: hidden;
    }
    header {
      position: fixed;
      left: 0;
      right: 0;
      top: 0;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: var(--header-bg);
      border-bottom: 1px solid var(--border-color);
      z-index: 50;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo {
      width: 24px;
      height: 24px;
    }
    .title {
      font-family: "Major Mono Display", monospace;
      letter-spacing: 1px;
      font-size: 18px;
      color: #fff;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-surface);
      color: var(--ink);
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .btn:hover { background: rgba(255,255,255,.1); }
    main {
      position: relative;
      height: 100vh;
      padding-top: 56px;
      overflow: hidden;
    }
    .dock {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      padding: 20px;
    }
    .app-icon {
      min-height: 120px;
      border-radius: 16px;
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      box-shadow: 0 8px 30px rgba(0,0,0,.5);
      padding: 14px 14px 16px;
      transition: transform 0.2s, box-shadow 0.3s;
    }
    .app-icon:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0,0,0,.6);
    }
    .app-icon h2 {
      margin: 0 0 8px;
      font-size: 13px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--brand-green);
    }
    .app-icon p {
      margin: 0 0 10px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }
    .cta {
      display: inline-block;
      margin-top: 12px;
      padding: 8px 12px;
      border-radius: 10px;
      border: none;
      background: var(--brand-red);
      color: #111;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .cta:hover { background: #d82f4c; }
    /* Window styling */
    .window {
      display: none;
      position: absolute;
      width: 800px;
      max-width: 90vw;
      min-height: 300px;
      border-radius: 16px;
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      box-shadow: 0 12px 50px rgba(0,0,0,.6);
      backdrop-filter: blur(12px);
      user-select: none;
      overflow: hidden;
    }
    .window-header {
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
      background: rgba(255,255,255,.05);
      cursor: pointer;
    }
    .window-title {
      font-weight: 600;
      font-size: 14px;
    }
    .window-controls {
      display: flex;
      gap: 6px;
    }
    .window-btn {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
    }
    .close-btn { background-color: #ff5f56; }
    .window-content {
      padding: 20px;
      height: calc(100% - 40px);
      overflow-y: auto;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
    }
    .form-group label {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
      display: block;
    }
    .form-input {
      background-color: rgba(0,0,0,0.2);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 14px;
      color: var(--ink);
      width: 100%;
      box-sizing: border-box;
    }
    .content-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 16px;
    }
    .content-table th, .content-table td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }
    .content-table thead th {
      color: var(--muted);
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.5px;
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="title">Haus Manager</div>
    </div>
    <div></div>
  </header>
  <main id="desktop">
    <div class="dock">
      <!-- Payment and reporting modules -->
      <section class="app-icon"><h2>Checkout</h2><p>Process one‑time payments.</p><button class="cta" data-action="open:checkout">Open</button></section>
      <section class="app-icon"><h2>Reports</h2><p>View recent transactions.</p><button class="cta" data-action="open:reports">Open</button></section>
      <section class="app-icon"><h2>Recurring</h2><p>Manage subscriptions.</p><button class="cta" data-action="open:recurring">Open</button></section>
      <section class="app-icon"><h2>Customer Vault</h2><p>Manage stored customer cards.</p><button class="cta" data-action="open:vault">Open</button></section>
      <section class="app-icon"><h2>Invoices</h2><p>Create and send invoices.</p><button class="cta" data-action="open:invoices">Open</button></section>
      <!-- Partner modules -->
      <section class="app-icon"><h2>Merchants</h2><p>Onboard and manage merchants.</p><button class="cta" data-action="open:merchants">Open</button></section>
      <section class="app-icon"><h2>Users</h2><p>Manage merchant users.</p><button class="cta" data-action="open:users">Open</button></section>
      <section class="app-icon"><h2>Billing &amp; Commission</h2><p>View billing & commission reports.</p><button class="cta" data-action="open:billing">Open</button></section>
    </div>
    <!-- Checkout Window -->
    <div id="window-checkout" class="window">
      <div class="window-header"><span class="window-title">Checkout</span><div class="window-controls"><button class="window-btn close-btn" data-action="close:checkout"></button></div></div>
      <div class="window-content">
        <form id="checkout-form" class="form-grid" onsubmit="return false;">
          <div class="form-group"><label for="card-name">Cardholder Name</label><input type="text" id="card-name" class="form-input" placeholder="John Doe" /></div>
          <div class="form-group"><label>Card Number</label><div id="card-number" class="form-input"></div></div>
          <div class="form-group"><label>Expiration Date</label><div id="exp-date" class="form-input"></div></div>
          <div class="form-group"><label>CVV</label><div id="cvv" class="form-input"></div></div>
          <div class="form-group"><label for="amount">Amount</label><input type="number" id="amount" class="form-input" min="0" step="0.01" placeholder="0.00" /></div>
          <div class="form-group"><button type="button" id="pay-button" class="cta">Pay</button></div>
        </form>
        <pre id="payment-response" style="white-space: pre-wrap; word-break: break-word;"></pre>
      </div>
    </div>
    <!-- Reports Window -->
    <div id="window-reports" class="window">
      <div class="window-header"><span class="window-title">Transaction Reports</span><div class="window-controls"><button class="window-btn close-btn" data-action="close:reports"></button></div></div>
      <div class="window-content">
        <button id="fetch-reports" class="cta">Fetch Transactions</button>
        <table id="transactions-table" class="content-table"><thead><tr><th>ID</th><th>Type</th><th>Amount</th><th>Status</th></tr></thead><tbody id="transactions-body"></tbody></table>
        <pre id="report-response" style="white-space: pre-wrap; word-break: break-word;"></pre>
      </div>
    </div>
    <!-- Recurring Window -->
    <div id="window-recurring" class="window">
      <div class="window-header"><span class="window-title">Recurring</span><div class="window-controls"><button class="window-btn close-btn" data-action="close:recurring"></button></div></div>
      <div class="window-content">
        <h3>Create Subscription</h3>
        <form id="recurring-form" class="form-grid" onsubmit="return false;">
          <div class="form-group"><label for="rec-plan-payments">Plan Payments</label><input type="number" id="rec-plan-payments" class="form-input" min="1" step="1" placeholder="e.g., 12" /></div>
          <div class="form-group"><label for="rec-plan-amount">Plan Amount</label><input type="number" id="rec-plan-amount" class="form-input" min="0" step="0.01" placeholder="e.g., 10.00" /></div>
          <div class="form-group"><label for="rec-day-frequency">Day Frequency</label><input type="number" id="rec-day-frequency" class="form-input" min="1" step="1" placeholder="e.g., 30" /></div>
          <div class="form-group"><label>Card Number</label><div id="rec-card-number" class="form-input"></div></div>
          <div class="form-group"><label>Expiration Date</label><div id="rec-exp-date" class="form-input"></div></div>
          <div class="form-group"><label>CVV</label><div id="rec-cvv" class="form-input"></div></div>
          <div class="form-group"><button type="button" id="rec-submit" class="cta">Create Subscription</button></div>
        </form>
        <pre id="rec-response" style="white-space: pre-wrap; word-break: break-word;"></pre>
      </div>
    </div>
    <!-- Vault Window -->
    <div id="window-vault" class="window">
      <div class="window-header"><span class="window-title">Customer Vault</span><div class="window-controls"><button class="window-btn close-btn" data-action="close:vault"></button></div></div>
      <div class="window-content">
        <h3>Add Customer to Vault</h3>
        <form id="vault-form" class="form-grid" onsubmit="return false;">
          <div class="form-group"><label>Cardholder Name</label><input type="text" id="vault-card-name" class="form-input" placeholder="John Doe" /></div>
          <div class="form-group"><label>Card Number</label><div id="vault-card-number" class="form-input"></div></div>
          <div class="form-group"><label>Expiration Date</label><div id="vault-exp-date" class="form-input"></div></div>
          <div class="form-group"><label>CVV</label><div id="vault-cvv" class="form-input"></div></div>
          <div class="form-group"><button type="button" id="vault-submit" class="cta">Add to Vault</button></div>
        </form>
        <pre id="vault-response" style="white-space: pre-wrap; word-break: break-word;"></pre>
        <h3>Charge Customer from Vault</h3>
        <form id="vault-charge-form" class="form-grid" onsubmit="return false;">
          <div class="form-group"><label for="vault-id">Customer Vault ID</label><input type="text" id="vault-id" class="form-input" /></div>
          <div class="form-group"><label for="vault-charge-amount">Amount</label><input type="number" id="vault-charge-amount" class="form-input" min="0" step="0.01" /></div>
          <div class="form-group"><button type="button" id="vault-charge-submit" class="cta">Charge</button></div>
        </form>
        <pre id="vault-charge-response" style="white-space: pre-wrap; word-break: break-word;"></pre>
      </div>
    </div>
    <!-- Invoices Window -->
    <div id="window-invoices" class="window">
      <div class="window-header"><span class="window-title">Invoices</span><div class="window-controls"><button class="window-btn close-btn" data-action="close:invoices"></button></div></div>
      <div class="window-content">
        <h3>Create Invoice</h3>
        <form id="invoice-form" class="form-grid" onsubmit="return false;">
          <div class="form-group"><label for="invoice-email">Customer Email</label><input type="email" id="invoice-email" class="form-input" placeholder="customer@example.com" /></div>
          <div class="form-group"><label for="invoice-amount">Amount</label><input type="number" id="invoice-amount" class="form-input" min="0" step="0.01" placeholder="100.00" /></div>
          <div class="form-group"><button type="button" id="invoice-create" class="cta">Create Invoice</button></div>
        </form>
        <pre id="invoice-response" style="white-space: pre-wrap; word-break: break-word;"></pre>
      </div>
    </div>
    <!-- Merchants Window -->
    <div id="window-merchants" class="window">
      <div class="window-header"><span class="window-title">Merchants</span><div class="window-controls"><button class="window-btn close-btn" data-action="close:merchants"></button></div></div>
      <div class="window-content">
        <h3>Merchant List</h3>
        <button id="merchants-fetch" class="cta">Fetch Merchant List</button>
        <pre id="merchants-list" style="white-space: pre-wrap; word-break: break-word; margin-top: 8px;"></pre>
        <h3>Create Merchant</h3>
        <form id="merchant-create-form" class="form-grid" onsubmit="return false;">
          <div class="form-group"><label for="merch-business-name">Business Name</label><input type="text" id="merch-business-name" class="form-input" /></div>
          <div class="form-group"><label for="merch-first-name">First Name</label><input type="text" id="merch-first-name" class="form-input" /></div>
          <div class="form-group"><label for="merch-last-name">Last Name</label><input type="text" id="merch-last-name" class="form-input" /></div>
          <div class="form-group"><label for="merch-email">Email</label><input type="email" id="merch-email" class="form-input" /></div>
          <div class="form-group"><label for="merch-phone">Phone</label><input type="text" id="merch-phone" class="form-input" /></div>
          <div class="form-group"><button type="button" id="merchant-create" class="cta">Create Merchant</button></div>
        </form>
        <pre id="merchant-create-response" style="white-space: pre-wrap; word-break: break-word;"></pre>
        <h3>Create Merchant API Key</h3>
        <form id="merchant-key-form" class="form-grid" onsubmit="return false;">
          <div class="form-group"><label for="merch-key-id">Merchant ID</label><input type="text" id="merch-key-id" class="form-input" /></div>
          <div class="form-group"><button type="button" id="merchant-key-create" class="cta">Generate API Key</button></div>
        </form>
        <pre id="merchant-key-response" style="white-space: pre-wrap; word-break: break-word;"></pre>
      </div>
    </div>
    <!-- Users Window -->
    <div id="window-users" class="window">
      <div class="window-header"><span class="window-title">Users</span><div class="window-controls"><button class="window-btn close-btn" data-action="close:users"></button></div></div>
      <div class="window-content">
        <h3>User List</h3>
        <form id="users-list-form" class="form-grid" onsubmit="return false;">
          <div class="form-group"><label for="list-users-merchant-id">Merchant ID</label><input type="text" id="list-users-merchant-id" class="form-input" /></div>
          <div class="form-group"><button type="button" id="users-fetch" class="cta">Fetch User List</button></div>
        </form>
        <pre id="users-list" style="white-space: pre-wrap; word-break: break-word; margin-top: 8px;"></pre>
        <h3>Create User</h3>
        <form id="user-create-form" class="form-grid" onsubmit="return false;">
          <div class="form-group"><label for="user-merchant-id">Merchant ID</label><input type="text" id="user-merchant-id" class="form-input" /></div>
          <div class="form-group"><label for="user-username">Username</label><input type="text" id="user-username" class="form-input" /></div>
          <div class="form-group"><label for="user-email">Email</label><input type="email" id="user-email" class="form-input" /></div>
          <div class="form-group"><label for="user-first-name">First Name</label><input type="text" id="user-first-name" class="form-input" /></div>
          <div class="form-group"><label for="user-last-name">Last Name</label><input type="text" id="user-last-name" class="form-input" /></div>
          <div class="form-group"><label for="user-role">Role</label><input type="text" id="user-role" class="form-input" placeholder="e.g., admin" /></div>
          <div class="form-group"><button type="button" id="user-create" class="cta">Create User</button></div>
        </form>
        <pre id="user-create-response" style="white-space: pre-wrap; word-break: break-word;"></pre>
      </div>
    </div>
    <!-- Billing Window -->
    <div id="window-billing" class="window">
      <div class="window-header"><span class="window-title">Billing &amp; Commission</span><div class="window-controls"><button class="window-btn close-btn" data-action="close:billing"></button></div></div>
      <div class="window-content">
        <h3>Merchant Billing</h3>
        <form id="billing-form" class="form-grid" onsubmit="return false;">
          <div class="form-group"><label for="billing-merchant-id">Merchant ID</label><input type="text" id="billing-merchant-id" class="form-input" /></div>
          <div class="form-group"><button type="button" id="billing-fetch" class="cta">Fetch Billing</button></div>
        </form>
        <pre id="billing-response" style="white-space: pre-wrap; word-break: break-word; margin-top: 8px;"></pre>
        <h3>Commission</h3>
        <form id="commission-form" class="form-grid" onsubmit="return false;">
          <div class="form-group"><label for="commission-merchant-id">Merchant ID</label><input type="text" id="commission-merchant-id" class="form-input" /></div>
          <div class="form-group"><button type="button" id="commission-fetch" class="cta">Fetch Commission</button></div>
        </form>
        <pre id="commission-response" style="white-space: pre-wrap; word-break: break-word; margin-top: 8px;"></pre>
      </div>
    </div>
  </main>
  <script>
    // Utility to manage windows
    document.addEventListener('click', (evt) => {
      const target = evt.target.closest('[data-action]');
      if (!target) return;
      const [action, id] = target.getAttribute('data-action').split(':');
      if (action === 'open') {
        const win = document.getElementById('window-' + id);
        if (win) {
          win.style.display = 'block';
          win.style.zIndex = Date.now().toString();
        }
      } else if (action === 'close') {
        const win = document.getElementById('window-' + id);
        if (win) win.style.display = 'none';
      }
    });
    // Fetch tokenization key and load CollectJS
    async function loadCollect() {
      try {
        const res = await fetch('/.netlify/functions/getTokenizationKey');
        const data = await res.json();
        const tokenKey = data.token || data.key || data.tokenization_key;
        const script = document.createElement('script');
        script.src = 'https://secure.nmi.com/token/Collect.js';
        script.setAttribute('data-tokenization-key', tokenKey);
        script.setAttribute('data-variant', 'inline');
        document.head.appendChild(script);
        script.onload = () => {
          console.log('CollectJS loaded');
        };
      } catch (err) {
        console.error('Failed to load CollectJS:', err);
      }
    }
    loadCollect();
    // Payment handler
    function handlePayment() {
      const amount = document.getElementById('amount').value || '0.00';
      if (typeof CollectJS === 'undefined') {
        document.getElementById('payment-response').textContent = 'Tokenization library not loaded';
        return;
      }
      CollectJS.tokenize({}, async function(resp) {
        const token = resp.token || resp.payment_token;
        try {
          const res = await fetch('/.netlify/functions/processPayment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount: amount, payment_token: token })
          });
          const text = await res.text();
          document.getElementById('payment-response').textContent = text;
        } catch (err) {
          document.getElementById('payment-response').textContent = 'Error: ' + err;
        }
      }, function(error) {
        document.getElementById('payment-response').textContent = 'Tokenisation error: ' + JSON.stringify(error);
      });
    }
    // Listeners for actions once DOM content loaded
    document.addEventListener('DOMContentLoaded', () => {
      // Payment button
      const payBtn = document.getElementById('pay-button');
      if (payBtn) payBtn.addEventListener('click', handlePayment);
      // Fetch transactions
      const reportBtn = document.getElementById('fetch-reports');
      if (reportBtn) reportBtn.addEventListener('click', async () => {
        const tbody = document.getElementById('transactions-body');
        tbody.innerHTML = '';
        document.getElementById('report-response').textContent = 'Loading...';
        try {
          const res = await fetch('/.netlify/functions/listTransactions');
          const text = await res.text();
          // parse query string lines
          const lines = text.trim().split(/\r?\n/);
          lines.forEach(line => {
            if (!line) return;
            const params = new URLSearchParams(line);
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${params.get('transaction_id') || ''}</td><td>${params.get('transaction_type') || ''}</td><td>${params.get('amount') || ''}</td><td>${params.get('response_text') || ''}</td>`;
            tbody.appendChild(tr);
          });
          if (!lines.length) document.getElementById('report-response').textContent = 'No transactions found.'; else document.getElementById('report-response').textContent = '';
        } catch (err) {
          document.getElementById('report-response').textContent = 'Error: ' + err;
        }
      });
      // Recurring subscription
      const recBtn = document.getElementById('rec-submit');
      if (recBtn) recBtn.addEventListener('click', () => {
        if (typeof CollectJS === 'undefined') {
          document.getElementById('rec-response').textContent = 'Tokenization library not loaded';
          return;
        }
        CollectJS.configure({
          variant: 'inline',
          fields: { cardNumber: { selector: '#rec-card-number' }, expirationDate: { selector: '#rec-exp-date' }, cvv: { selector: '#rec-cvv' } }
        });
        CollectJS.tokenize({}, async function(resp) {
          const token = resp.token || resp.payment_token;
          const payload = {
            plan_payments: document.getElementById('rec-plan-payments').value,
            plan_amount: document.getElementById('rec-plan-amount').value,
            day_frequency: document.getElementById('rec-day-frequency').value,
            payment_token: token
          };
          try {
            const res = await fetch('/.netlify/functions/createSubscription', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const text = await res.text();
            document.getElementById('rec-response').textContent = text;
          } catch (err) {
            document.getElementById('rec-response').textContent = 'Error: ' + err;
          }
        }, function(error) {
          document.getElementById('rec-response').textContent = 'Tokenisation error: ' + JSON.stringify(error);
        });
      });
      // Vault add customer
      const vaultAddBtn = document.getElementById('vault-submit');
      if (vaultAddBtn) vaultAddBtn.addEventListener('click', () => {
        if (typeof CollectJS === 'undefined') {
          document.getElementById('vault-response').textContent = 'Tokenization library not loaded';
          return;
        }
        CollectJS.configure({
          variant: 'inline',
          fields: { cardNumber: { selector: '#vault-card-number' }, expirationDate: { selector: '#vault-exp-date' }, cvv: { selector: '#vault-cvv' } }
        });
        CollectJS.tokenize({}, async function(resp) {
          const token = resp.token || resp.payment_token;
          const payload = {
            first_name: document.getElementById('vault-card-name').value,
            payment_token: token
          };
          try {
            const res = await fetch('/.netlify/functions/addCustomerToVault', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const text = await res.text();
            document.getElementById('vault-response').textContent = text;
          } catch (err) {
            document.getElementById('vault-response').textContent = 'Error: ' + err;
          }
        }, function(error) {
          document.getElementById('vault-response').textContent = 'Tokenisation error: ' + JSON.stringify(error);
        });
      });
      // Vault charge customer
      const vaultChargeBtn = document.getElementById('vault-charge-submit');
      if (vaultChargeBtn) vaultChargeBtn.addEventListener('click', async () => {
        const payload = {
          customer_vault_id: document.getElementById('vault-id').value,
          amount: document.getElementById('vault-charge-amount').value
        };
        try {
          const res = await fetch('/.netlify/functions/chargeCustomerVault', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          const text = await res.text();
          document.getElementById('vault-charge-response').textContent = text;
        } catch (err) {
          document.getElementById('vault-charge-response').textContent = 'Error: ' + err;
        }
      });
      // Invoice
      const invoiceBtn = document.getElementById('invoice-create');
      if (invoiceBtn) invoiceBtn.addEventListener('click', async () => {
        const payload = {
          email: document.getElementById('invoice-email').value,
          amount: document.getElementById('invoice-amount').value
        };
        try {
          const res = await fetch('/.netlify/functions/createInvoice', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          const text = await res.text();
          document.getElementById('invoice-response').textContent = text;
        } catch (err) {
          document.getElementById('invoice-response').textContent = 'Error: ' + err;
        }
      });
      // Merchants: fetch list
      const merchFetchBtn = document.getElementById('merchants-fetch');
      if (merchFetchBtn) merchFetchBtn.addEventListener('click', async () => {
        const pre = document.getElementById('merchants-list');
        pre.textContent = 'Loading...';
        try {
          const res = await fetch('/.netlify/functions/listMerchants');
          const text = await res.text();
          pre.textContent = text;
        } catch (err) {
          pre.textContent = 'Error: ' + err;
        }
      });
      // Merchants: create
      const merchCreateBtn = document.getElementById('merchant-create');
      if (merchCreateBtn) merchCreateBtn.addEventListener('click', async () => {
        const payload = {
          company: document.getElementById('merch-business-name').value,
          owner_first_name: document.getElementById('merch-first-name').value,
          owner_last_name: document.getElementById('merch-last-name').value,
          email: document.getElementById('merch-email').value,
          phone: document.getElementById('merch-phone').value
        };
        const pre = document.getElementById('merchant-create-response');
        pre.textContent = 'Submitting...';
        try {
          const res = await fetch('/.netlify/functions/createMerchant', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          const text = await res.text();
          pre.textContent = text;
        } catch (err) {
          pre.textContent = 'Error: ' + err;
        }
      });
      // Merchants: generate key
      const merchKeyBtn = document.getElementById('merchant-key-create');
      if (merchKeyBtn) merchKeyBtn.addEventListener('click', async () => {
        const id = document.getElementById('merch-key-id').value;
        const pre = document.getElementById('merchant-key-response');
        pre.textContent = 'Submitting...';
        try {
          const res = await fetch('/.netlify/functions/generateMerchantKey?merchant_id=' + encodeURIComponent(id));
          const text = await res.text();
          pre.textContent = text;
        } catch (err) {
          pre.textContent = 'Error: ' + err;
        }
      });
      // Users: fetch list
      const usersFetchBtn = document.getElementById('users-fetch');
      if (usersFetchBtn) usersFetchBtn.addEventListener('click', async () => {
        const merchantId = document.getElementById('list-users-merchant-id').value;
        const pre = document.getElementById('users-list');
        pre.textContent = 'Loading...';
        try {
          const res = await fetch('/.netlify/functions/listUsers?merchant_id=' + encodeURIComponent(merchantId));
          const json = await res.json();
          pre.textContent = JSON.stringify(json, null, 2);
        } catch (err) {
          pre.textContent = 'Error: ' + err;
        }
      });
      // Users: create
      const userCreateBtn = document.getElementById('user-create');
      if (userCreateBtn) userCreateBtn.addEventListener('click', async () => {
        const payload = {
          merchant_id: document.getElementById('user-merchant-id').value,
          username: document.getElementById('user-username').value,
          email: document.getElementById('user-email').value,
          first_name: document.getElementById('user-first-name').value,
          last_name: document.getElementById('user-last-name').value,
          role: document.getElementById('user-role').value,
          status: 'active'
        };
        const pre = document.getElementById('user-create-response');
        pre.textContent = 'Submitting...';
        try {
          const res = await fetch('/.netlify/functions/createUser', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          const text = await res.text();
          pre.textContent = text;
        } catch (err) {
          pre.textContent = 'Error: ' + err;
        }
      });
      // Billing fetch
      const billingBtn = document.getElementById('billing-fetch');
      if (billingBtn) billingBtn.addEventListener('click', async () => {
        const merchantId = document.getElementById('billing-merchant-id').value;
        const pre = document.getElementById('billing-response');
        pre.textContent = 'Loading...';
        try {
          const res = await fetch('/.netlify/functions/listBilling?merchant_id=' + encodeURIComponent(merchantId));
          const text = await res.text();
          pre.textContent = text;
        } catch (err) {
          pre.textContent = 'Error: ' + err;
        }
      });
      // Commission fetch
      const commissionBtn = document.getElementById('commission-fetch');
      if (commissionBtn) commissionBtn.addEventListener('click', async () => {
        const merchantId = document.getElementById('commission-merchant-id').value;
        const pre = document.getElementById('commission-response');
        pre.textContent = 'Loading...';
        try {
          const res = await fetch('/.netlify/functions/listCommission?merchant_id=' + encodeURIComponent(merchantId));
          const text = await res.text();
          pre.textContent = text;
        } catch (err) {
          pre.textContent = 'Error: ' + err;
        }
      });
    });
  </script>
</body>
</html>